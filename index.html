<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Parcel Editor Web GIS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
  <style>
    #map {
      height: 100vh;
      width: 75%;
      float: left;
    }
    #panel {
      width: 25%;
      float: right;
      height: 100vh;
      padding: 10px;
      box-sizing: border-box;
      background-color: #f8f9fa;
      border-left: 1px solid #ccc;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type=text] {
      width: 100%;
      padding: 5px;
    }
    button {
      margin-top: 10px;
      padding: 8px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="panel">
    <h3>Edit Parcel</h3>
    <label>Owner Name:</label>
    <input type="text" id="ownerInput" />
    <button onclick="saveChanges()">Save Changes</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
  <script>
    const map = L.map('map').setView([22.572, 88.365], 17);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    let selectedLayer = null;
    let parcelLayer;

    fetch('data/parcels.geojson')
      .then(res => res.json())
      .then(data => {
        parcelLayer = L.geoJSON(data, {
          style: { color: "#ff7800", weight: 2 },
          onEachFeature: function (feature, layer) {
            layer.on('click', function () {
              selectedLayer = layer;
              document.getElementById('ownerInput').value = feature.properties.owner || "";
            });
            layer.bindPopup("Owner: " + feature.properties.owner);
          }
        }).addTo(map);
      });

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
      draw: {
        polygon: false,
        rectangle: false,
        circle: false,
        marker: false,
        circlemarker: false,
        polyline: {
          shapeOptions: {
            color: 'blue',
            weight: 3
          }
        }
      },
      edit: {
        featureGroup: drawnItems,
        remove: true
      }
    });
    map.addControl(drawControl);

    map.on(L.Draw.Event.CREATED, function (event) {
      const layer = event.layer;
      if (event.layerType === 'polyline') {
        if (parcelLayer) {
          const polyline = layer.toGeoJSON();
          const newFeatures = [];

          parcelLayer.eachLayer(function (pLayer) {
            const parcel = pLayer.toGeoJSON();
            try {
              const splitResult = turf.lineSplit(parcel, polyline);
              if (splitResult.features.length > 1) {
                splitResult.features.forEach(f => {
                  f.properties = { ...parcel.properties };
                  newFeatures.push(f);
                });
              } else {
                newFeatures.push(parcel);
              }
            } catch (e) {
              console.error("Split failed: ", e);
              newFeatures.push(parcel);
            }
          });

          map.removeLayer(parcelLayer);
          parcelLayer = L.geoJSON(newFeatures, {
            style: { color: '#00cc88', weight: 2 },
            onEachFeature: function (feature, layer) {
              layer.on('click', function () {
                selectedLayer = layer;
                document.getElementById('ownerInput').value = feature.properties.owner || "";
              });
              layer.bindPopup("Owner: " + feature.properties.owner);
            }
          }).addTo(map);
        }
      }
      drawnItems.addLayer(layer);
    });

    function saveChanges() {
      if (selectedLayer) {
        const newOwner = document.getElementById('ownerInput').value;
        selectedLayer.feature.properties.owner = newOwner;
        selectedLayer.bindPopup("Owner: " + newOwner);
        alert("Attribute updated.");
      } else {
        alert("Please select a parcel.");
      }
    }
  </script>
</body>
</html>
